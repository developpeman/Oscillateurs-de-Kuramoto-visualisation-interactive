(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class g{constructor(e=16){this.N=e,this.phases=new Float64Array(e),this.frequencies=new Float64Array(e),this.dPhases=new Float64Array(e),this.K=1,this.setFrequencies("identical"),this.setInitialPhases("random")}setFrequencies(e){const t=this.N;switch(e){case"identical":this.frequencies.fill(1);break;case"random":for(let s=0;s<t;s++)this.frequencies[s]=.8+Math.random()*.4;break;case"twoGroups":for(let s=0;s<t;s++)this.frequencies[s]=s<t/2?.8:1.2;break}}setInitialPhases(e){const t=this.N,s=2*Math.PI;switch(e){case"random":for(let i=0;i<t;i++)this.phases[i]=Math.random()*s;break;case"quasiSync":const n=Math.random()*s;for(let i=0;i<t;i++)this.phases[i]=n+(Math.random()-.5)*.3;break;case"twisted1":for(let i=0;i<t;i++)this.phases[i]=s*i/t;break;case"twisted2":for(let i=0;i<t;i++)this.phases[i]=4*Math.PI*i/t;break}this.normalizePhases()}perturb(e=.1){for(let t=0;t<this.N;t++)this.phases[t]+=(Math.random()-.5)*2*e*Math.PI;this.normalizePhases()}normalizePhases(){const e=2*Math.PI;for(let t=0;t<this.N;t++)this.phases[t]=(this.phases[t]%e+e)%e}computeDerivatives(){const e=this.N,s=this.K/2;for(let n=0;n<e;n++){const i=(n-1+e)%e,r=(n+1)%e,a=s*(Math.sin(this.phases[r]-this.phases[n])+Math.sin(this.phases[i]-this.phases[n]));this.dPhases[n]=this.frequencies[n]+a}}step(e){this.computeDerivatives();for(let t=0;t<this.N;t++)this.phases[t]+=this.dPhases[t]*e;this.normalizePhases()}stepRK4(e){const t=this.N,s=new Float64Array(t),n=new Float64Array(t),i=new Float64Array(t),r=new Float64Array(t),a=new Float64Array(t);this.computeDerivatives(),s.set(this.dPhases);for(let o=0;o<t;o++)a[o]=this.phases[o]+.5*e*s[o];this.computeDerivativesFor(a,n);for(let o=0;o<t;o++)a[o]=this.phases[o]+.5*e*n[o];this.computeDerivativesFor(a,i);for(let o=0;o<t;o++)a[o]=this.phases[o]+e*i[o];this.computeDerivativesFor(a,r);for(let o=0;o<t;o++)this.phases[o]+=e/6*(s[o]+2*n[o]+2*i[o]+r[o]);this.normalizePhases()}computeDerivativesFor(e,t){const s=this.N,n=this.K/2;for(let i=0;i<s;i++){const r=(i-1+s)%s,a=(i+1)%s,o=n*(Math.sin(e[a]-e[i])+Math.sin(e[r]-e[i]));t[i]=this.frequencies[i]+o}}getOrderParameter(){let e=0,t=0;for(let i=0;i<this.N;i++)e+=Math.cos(this.phases[i]),t+=Math.sin(this.phases[i]);e/=this.N,t/=this.N;const s=Math.sqrt(e*e+t*t),n=Math.atan2(t,e);return{r:s,psi:n}}getWindingNumber(){let e=0;const t=2*Math.PI;for(let s=0;s<this.N;s++){const n=(s+1)%this.N;let i=this.phases[n]-this.phases[s];for(;i>Math.PI;)i-=t;for(;i<-Math.PI;)i+=t;e+=i}return Math.round(e/t)}getPhaseVariance(){const{r:e}=this.getOrderParameter();return 1-e}classifyState(){const{r:e}=this.getOrderParameter(),t=this.getWindingNumber();return e>.9?"Synchronisé (q=0)":Math.abs(t)===1&&e<.5?`Twisted (q=${t})`:Math.abs(t)===2&&e<.3?`Twisted (q=${t})`:e<.3?"Désynchronisé":`Partiel (r=${e.toFixed(2)}, q=${t})`}getPhases(){return new Float64Array(this.phases)}setCoupling(e){this.K=Math.max(0,e)}}class m{constructor(){this.N=16,this.K=1,this.dt=.02,this.speedMultiplier=1,this.running=!1,this.time=0,this.mode=1,this.frequencyType="identical",this.sweeping=!1,this.sweepDirection=0,this.sweepSpeed=.005,this.rHistory=[],this.maxHistoryLength=500,this.hysteresisUp=[],this.hysteresisDown=[],this.experimentResults=null,this.onStateChange=null}setRunning(e){this.running=e,this.notifyChange("running")}toggleRunning(){return this.running=!this.running,this.notifyChange("running"),this.running}setK(e){this.K=Math.max(0,Math.min(5,e)),this.notifyChange("K")}setMode(e){this.mode=e,this.notifyChange("mode")}setFrequencyType(e){this.frequencyType=e,this.notifyChange("frequencyType")}setSpeed(e){this.speedMultiplier=Math.max(.25,Math.min(4,e)),this.notifyChange("speed")}startSweep(e){this.sweeping=!0,this.sweepDirection=e,e>0?this.hysteresisUp=[]:this.hysteresisDown=[],this.notifyChange("sweep")}stopSweep(){this.sweeping=!1,this.sweepDirection=0,this.notifyChange("sweep")}updateSweep(){return this.sweeping?(this.K+=this.sweepDirection*this.sweepSpeed,this.K<=0?(this.K=0,this.stopSweep()):this.K>=5&&(this.K=5,this.stopSweep()),this.sweeping):!1}addToHistory(e,t){if(this.rHistory.push(e),this.rHistory.length>this.maxHistoryLength&&this.rHistory.shift(),this.sweeping){const s={K:this.K,r:e};this.sweepDirection>0?this.hysteresisUp.push(s):this.hysteresisDown.push(s)}}clearHistory(){this.rHistory=[],this.time=0}clearHysteresis(){this.hysteresisUp=[],this.hysteresisDown=[]}reset(){this.K=1,this.running=!1,this.time=0,this.sweeping=!1,this.sweepDirection=0,this.clearHistory(),this.notifyChange("reset")}fullReset(){this.reset(),this.clearHysteresis(),this.experimentResults=null,this.notifyChange("fullReset")}getEffectiveDt(){return this.dt*this.speedMultiplier}notifyChange(e){this.onStateChange&&this.onStateChange(e,this)}getModeDescription(){return{1:`<strong>Mode 1 : Transition vers la synchronisation</strong><br>
                J'augmente K progressivement pour observer l'émergence de la synchronisation. 
                Le paramètre d'ordre r passe de ~0 (désordre) à ~1 (ordre parfait).`,2:`<strong>Mode 2 : Bistabilité synchro / twisted</strong><br>
                Avec le même K, différentes conditions initiales mènent à différents attracteurs. 
                Je compare "Quasi-sync" et "Twisted q=1".`,3:`<strong>Mode 3 : Hystérèse</strong><br>
                J'utilise les balayages K↑ et K↓ pour observer que les seuils de transition 
                diffèrent selon le sens de variation : c'est l'hystérèse.`,4:`<strong>Mode 4 : Expérience statistique</strong><br>
                Je lance plusieurs simulations avec des conditions aléatoires pour estimer 
                la taille des bassins d'attraction de chaque état.`}[this.mode]||""}}const h=new m;class f{constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.width=e.width,this.height=e.height,this.centerX=this.width/2,this.centerY=this.height/2,this.ringRadius=Math.min(this.width,this.height)*.35,this.nodeRadius=18,this.needleLength=14}phaseToColor(e){return`hsl(${e/(2*Math.PI)*360}, 85%, 55%)`}render(e){const t=this.ctx,s=e.length;t.fillStyle="rgba(0, 0, 0, 0.1)",t.fillRect(0,0,this.width,this.height),t.beginPath(),t.arc(this.centerX,this.centerY,this.ringRadius,0,2*Math.PI),t.strokeStyle="rgba(100, 100, 150, 0.3)",t.lineWidth=2,t.stroke(),t.beginPath(),t.strokeStyle="rgba(99, 102, 241, 0.2)",t.lineWidth=1;for(let n=0;n<s;n++){const i=2*Math.PI*n/s-Math.PI/2,r=2*Math.PI*((n+1)%s)/s-Math.PI/2,a=this.centerX+this.ringRadius*Math.cos(i),o=this.centerY+this.ringRadius*Math.sin(i),l=this.centerX+this.ringRadius*Math.cos(r),c=this.centerY+this.ringRadius*Math.sin(r);t.moveTo(a,o),t.lineTo(l,c)}t.stroke();for(let n=0;n<s;n++){const i=2*Math.PI*n/s-Math.PI/2,r=this.centerX+this.ringRadius*Math.cos(i),a=this.centerY+this.ringRadius*Math.sin(i),o=e[n],l=this.phaseToColor(o);t.beginPath(),t.arc(r,a,this.nodeRadius,0,2*Math.PI),t.fillStyle=l,t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=2,t.stroke();const c=o-Math.PI/2,d=r+this.needleLength*Math.cos(c),p=a+this.needleLength*Math.sin(c);t.beginPath(),t.moveTo(r,a),t.lineTo(d,p),t.strokeStyle="rgba(255, 255, 255, 0.9)",t.lineWidth=2,t.lineCap="round",t.stroke(),t.beginPath(),t.arc(d,p,3,0,2*Math.PI),t.fillStyle="white",t.fill()}t.fillStyle="rgba(255, 255, 255, 0.6)",t.font="12px Inter, sans-serif",t.textAlign="center",t.fillText(`N = ${s}`,this.centerX,this.centerY+5)}clear(){this.ctx.clearRect(0,0,this.width,this.height)}}class y{constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.width=e.width,this.height=e.height,this.centerX=this.width/2,this.centerY=this.height/2,this.circleRadius=Math.min(this.width,this.height)*.38,this.pointRadius=8}phaseToColor(e){return`hsl(${e/(2*Math.PI)*360}, 85%, 55%)`}render(e,t){const s=this.ctx,n=e.length;s.fillStyle="rgba(0, 0, 0, 0.1)",s.fillRect(0,0,this.width,this.height),s.beginPath(),s.arc(this.centerX,this.centerY,this.circleRadius,0,2*Math.PI),s.strokeStyle="rgba(100, 100, 150, 0.4)",s.lineWidth=2,s.stroke();for(let i=0;i<8;i++){const r=2*Math.PI*i/8;s.beginPath(),s.moveTo(this.centerX+(this.circleRadius-8)*Math.cos(r),this.centerY+(this.circleRadius-8)*Math.sin(r)),s.lineTo(this.centerX+(this.circleRadius+8)*Math.cos(r),this.centerY+(this.circleRadius+8)*Math.sin(r)),s.strokeStyle="rgba(100, 100, 150, 0.3)",s.lineWidth=1,s.stroke()}for(let i=0;i<n;i++){const r=e[i],a=this.centerX+this.circleRadius*Math.cos(r),o=this.centerY+this.circleRadius*Math.sin(r),l=this.phaseToColor(r);s.beginPath(),s.arc(a,o,this.pointRadius,0,2*Math.PI),s.fillStyle=l,s.fill(),s.strokeStyle="rgba(255, 255, 255, 0.4)",s.lineWidth=1.5,s.stroke()}if(t){const{r:i,psi:r}=t,a=i*this.circleRadius,o=this.centerX+a*Math.cos(r),l=this.centerY+a*Math.sin(r);s.beginPath(),s.moveTo(this.centerX,this.centerY),s.lineTo(o,l),s.strokeStyle="rgba(16, 185, 129, 1)",s.lineWidth=4,s.lineCap="round",s.stroke(),s.fillStyle="rgba(255, 255, 255, 0.9)",s.font="bold 14px monospace",s.textAlign="center",s.fillText(`r=${i.toFixed(2)}`,this.centerX+(a+25)*Math.cos(r),this.centerY+(a+25)*Math.sin(r))}s.beginPath(),s.arc(this.centerX,this.centerY,4,0,2*Math.PI),s.fillStyle="rgba(99, 102, 241, 0.8)",s.fill()}clear(){this.ctx.clearRect(0,0,this.width,this.height)}}class w{constructor(e,t){this.rCanvas=e,this.rCtx=e.getContext("2d"),this.hCanvas=t,this.hCtx=t.getContext("2d"),this.padding={top:20,right:20,bottom:30,left:45}}renderRGraph(e){const t=this.rCtx,s=this.rCanvas.width,n=this.rCanvas.height,i=this.padding;t.fillStyle="#0a0a0f",t.fillRect(0,0,s,n);const r=s-i.left-i.right,a=n-i.top-i.bottom;if(t.strokeStyle="rgba(100, 100, 150, 0.5)",t.lineWidth=1,t.beginPath(),t.moveTo(i.left,i.top),t.lineTo(i.left,n-i.bottom),t.lineTo(s-i.right,n-i.bottom),t.stroke(),t.fillStyle="rgba(160, 160, 176, 0.8)",t.font="11px monospace",t.textAlign="right",t.fillText("1.0",i.left-5,i.top+5),t.fillText("0.5",i.left-5,i.top+a/2+3),t.fillText("0.0",i.left-5,n-i.bottom+3),t.strokeStyle="rgba(100, 100, 150, 0.2)",t.setLineDash([3,3]),t.beginPath(),t.moveTo(i.left,i.top+a/2),t.lineTo(s-i.right,i.top+a/2),t.stroke(),t.setLineDash([]),e.length>1){t.beginPath(),t.strokeStyle="rgba(6, 182, 212, 0.9)",t.lineWidth=2;for(let o=0;o<e.length;o++){const l=i.left+o/(e.length-1)*r,c=n-i.bottom-e[o]*a;o===0?t.moveTo(l,c):t.lineTo(l,c)}t.stroke()}t.fillStyle="rgba(160, 160, 176, 0.6)",t.textAlign="center",t.fillText("temps →",s/2,n-5)}renderHysteresis(e,t){const s=this.hCtx,n=this.hCanvas.width,i=this.hCanvas.height,r=this.padding;s.fillStyle="#0a0a0f",s.fillRect(0,0,n,i);const a=n-r.left-r.right,o=i-r.top-r.bottom;s.strokeStyle="rgba(100, 100, 150, 0.5)",s.lineWidth=1,s.beginPath(),s.moveTo(r.left,r.top),s.lineTo(r.left,i-r.bottom),s.lineTo(n-r.right,i-r.bottom),s.stroke(),s.fillStyle="rgba(160, 160, 176, 0.8)",s.font="11px monospace",s.textAlign="right",s.fillText("1.0",r.left-5,r.top+5),s.fillText("0.0",r.left-5,i-r.bottom+3),s.textAlign="center",s.fillText("0",r.left,i-8),s.fillText("5",n-r.right,i-8),s.fillText("K",n/2,i-5),this.plotCurve(s,e,a,o,r,"rgba(6, 182, 212, 0.9)",n,i),this.plotCurve(s,t,a,o,r,"rgba(236, 72, 153, 0.9)",n,i),(e.length>0||t.length>0)&&(s.font="10px sans-serif",s.fillStyle="rgba(6, 182, 212, 0.9)",s.fillText("▲ K↑",n-40,r.top+10),s.fillStyle="rgba(236, 72, 153, 0.9)",s.fillText("▼ K↓",n-40,r.top+22))}plotCurve(e,t,s,n,i,r,a,o){if(!(t.length<2)){e.beginPath(),e.strokeStyle=r,e.lineWidth=2;for(let l=0;l<t.length;l++){const c=i.left+t[l].K/5*s,d=o-i.bottom-t[l].r*n;l===0?e.moveTo(c,d):e.lineTo(c,d)}e.stroke()}}}class b{constructor(e,t){this.simulator=e,this.onUpdate=t,this.setupEventListeners()}setupEventListeners(){document.querySelectorAll(".mode-btn").forEach(n=>{n.addEventListener("click",()=>{document.querySelectorAll(".mode-btn").forEach(r=>r.classList.remove("active")),n.classList.add("active"),h.setMode(parseInt(n.dataset.mode)),document.getElementById("modeDescription").innerHTML=h.getModeDescription();const i=document.getElementById("experimentPanel");i.style.display=h.mode===4?"block":"none"})});const e=document.getElementById("kSlider");e.addEventListener("input",()=>{h.setK(parseFloat(e.value)),this.simulator.setCoupling(h.K),document.getElementById("kValue").textContent=h.K.toFixed(2)}),document.getElementById("sweepUpBtn").addEventListener("click",()=>{h.startSweep(1),h.setRunning(!0)}),document.getElementById("sweepDownBtn").addEventListener("click",()=>{h.startSweep(-1),h.setRunning(!0)}),document.getElementById("stopSweepBtn").addEventListener("click",()=>{h.stopSweep()}),document.querySelectorAll(".preset-btn[data-freq]").forEach(n=>{n.addEventListener("click",()=>{document.querySelectorAll(".preset-btn[data-freq]").forEach(i=>i.classList.remove("active")),n.classList.add("active"),this.simulator.setFrequencies(n.dataset.freq),h.setFrequencyType(n.dataset.freq)})}),document.querySelectorAll(".init-btn").forEach(n=>{n.addEventListener("click",()=>{this.simulator.setInitialPhases(n.dataset.init),h.clearHistory(),this.onUpdate()})});const t=document.getElementById("perturbSlider");t.addEventListener("input",()=>{document.getElementById("perturbValue").textContent=parseFloat(t.value).toFixed(2)}),document.getElementById("perturbBtn").addEventListener("click",()=>{const n=parseFloat(t.value);this.simulator.perturb(n),this.onUpdate()});const s=document.getElementById("speedSlider");s.addEventListener("input",()=>{h.setSpeed(parseFloat(s.value)),document.getElementById("speedValue").textContent=`×${h.speedMultiplier.toFixed(2)}`}),document.getElementById("playPauseBtn").addEventListener("click",()=>{const n=h.toggleRunning();document.getElementById("playPauseBtn").textContent=n?"⏸ Pause":"▶ Play",document.body.classList.toggle("running",n)}),document.getElementById("stepBtn").addEventListener("click",()=>{this.simulator.step(h.getEffectiveDt()),this.onUpdate()}),document.getElementById("resetBtn").addEventListener("click",()=>{h.reset(),this.simulator.setCoupling(1),this.simulator.setInitialPhases("random"),e.value=1,document.getElementById("kValue").textContent="1.00",document.getElementById("playPauseBtn").textContent="▶ Play",document.body.classList.remove("running"),this.onUpdate()})}updateDisplays(e,t,s){document.getElementById("rValue").textContent=e.toFixed(3),document.getElementById("qValue").textContent=t,document.getElementById("varValue").textContent=s.toFixed(3),document.getElementById("kValue").textContent=h.K.toFixed(2),document.getElementById("kSlider").value=h.K,document.getElementById("stateLabel").textContent=`État : ${this.simulator.classifyState()}`}}class x{constructor(){this.results=null}async run(e,t,s=16,n=2e3){const i={sync:0,twisted1:0,twisted2:0,other:0,total:e},r=document.getElementById("experimentResults");r.innerHTML='<p style="color: var(--accent-tertiary);">Simulation en cours...</p>';for(let a=0;a<e;a++){const o=new g(s);o.setCoupling(t),o.setFrequencies("identical"),o.setInitialPhases("random");for(let d=0;d<n;d++)o.step(.02);const{r:l}=o.getOrderParameter(),c=o.getWindingNumber();l>.85?i.sync++:Math.abs(c)===1?i.twisted1++:Math.abs(c)===2?i.twisted2++:i.other++,a%10===0&&(r.innerHTML=`<p style="color: var(--accent-tertiary);">Simulation ${a+1}/${e}...</p>`,await new Promise(d=>setTimeout(d,0)))}return this.results=i,this.displayResults(i,t),i}displayResults(e,t){const s=document.getElementById("experimentResults"),n=e.total,i=(e.sync/n*100).toFixed(1),r=(e.twisted1/n*100).toFixed(1),a=(e.twisted2/n*100).toFixed(1),o=(e.other/n*100).toFixed(1);s.innerHTML=`
            <div style="margin-bottom: 10px; font-size: 12px; color: var(--text-secondary);">
                K = ${t.toFixed(2)}, N = ${n} simulations
            </div>
            <div class="bar-chart">
                ${this.createBar("Synchro (q=0)",i,"#10b981")}
                ${this.createBar("Twisted q=1",r,"#6366f1")}
                ${this.createBar("Twisted q=2",a,"#8b5cf6")}
                ${this.createBar("Autre",o,"#64748b")}
            </div>
        `}createBar(e,t,s){return`
            <div style="margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px;">
                    <span>${e}</span>
                    <span style="color: ${s};">${t}%</span>
                </div>
                <div style="background: rgba(0,0,0,0.3); border-radius: 4px; height: 16px; overflow: hidden;">
                    <div style="width: ${t}%; height: 100%; background: ${s}; border-radius: 4px; transition: width 0.5s;"></div>
                </div>
            </div>
        `}}class v{constructor(){this.simulator=new g(16),this.ringView=new f(document.getElementById("ringCanvas")),this.phaseCircle=new y(document.getElementById("phaseCanvas")),this.graphs=new w(document.getElementById("rGraphCanvas"),document.getElementById("hysteresisCanvas")),this.controls=new b(this.simulator,()=>this.updateVisuals()),this.experiments=new x,document.getElementById("runExperimentBtn").addEventListener("click",()=>{const e=parseInt(document.getElementById("numSimsInput").value)||50;this.experiments.run(e,h.K,16,2e3)}),this.updateVisuals(),this.lastTime=0,this.animate=this.animate.bind(this),requestAnimationFrame(this.animate),console.log("Kuramoto Oscillator Visualization initialized")}animate(e){if(requestAnimationFrame(this.animate),h.running){const t=h.getEffectiveDt();this.simulator.step(t),h.time+=t,h.sweeping&&(h.updateSweep(),this.simulator.setCoupling(h.K)),this.updateVisuals()}}updateVisuals(){const e=this.simulator.getPhases(),t=this.simulator.getOrderParameter(),s=this.simulator.getWindingNumber(),n=this.simulator.getPhaseVariance();h.addToHistory(t.r,h.K),this.ringView.render(e),this.phaseCircle.render(e,t),this.graphs.renderRGraph(h.rHistory),this.graphs.renderHysteresis(h.hysteresisUp,h.hysteresisDown),this.controls.updateDisplays(t.r,s,n)}}document.addEventListener("DOMContentLoaded",()=>{window.app=new v});
